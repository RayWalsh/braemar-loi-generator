<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Braemar LOI Generator</title>
  <style>
    :root {
      --braemar-soft-grey: #f8f6f5;
      --braemar-forest-green: #336e63;
      --braemar-ocean-blue: #182432;
      --braemar-accent-green: #2dd782;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      padding: 0;
      box-sizing: border-box;
      background: var(--braemar-soft-grey);
      color: var(--braemar-ocean-blue);
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 1rem;
      color: var(--braemar-forest-green);
      text-align: center;
    }
    form {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
      color: var(--braemar-ocean-blue);
    }
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1rem;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--braemar-forest-green);
      box-shadow: 0 0 0 2px rgba(51,110,99,0.2);
    }
    #preview, #jsonOutput, #debugConsole {
      margin-top: 2rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      white-space: pre-wrap;
    }
    #jsonOutput, #debugConsole {
      font-size: 0.9rem;
      color: #333;
      background: #eef;
    }
    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    button {
      background-color: var(--braemar-accent-green);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #24c173;
    }
    .spinner {
      display: none;
      margin-top: 1rem;
    }
    @media (min-width: 768px) {
      body {
        max-width: 768px;
        margin: 2rem auto;
      }
    }
  </style>
</head>
<body>
  <h1>Braemar Letter of Indemnity Generator</h1>

  <form id="loiForm">
    <label>Upload Document:
      <input type="file" id="fileInput">
    </label>
    <button type="button" onclick="analyzeDocument()">Extract Data from Document</button>
    <div class="spinner" id="spinner">⏳ Processing document...</div>

    <!-- Form fields omitted for brevity but unchanged -->
  </form>

  <div class="actions">
    <button onclick="copyText()">Copy Text</button>
    <button onclick="downloadWord()">Download Word</button>
  </div>

  <div id="preview"></div>
  <h3>Extracted JSON</h3>
  <div id="jsonOutput"></div>
  <h3>Debug Console</h3>
  <div id="debugConsole"></div>

  <script>
    const form = document.getElementById('loiForm');
    const preview = document.getElementById('preview');
    const spinner = document.getElementById('spinner');
    const jsonOutput = document.getElementById('jsonOutput');
    const debugConsole = document.getElementById('debugConsole');
    const fileInput = document.getElementById('fileInput');

    const endpoint = "https://bldataextractor1.cognitiveservices.azure.com/";
    const apiKey = "3ced498fc6a24e01ab8be5992d41c2d1";
    const modelId = "BLDataExtractorPass1";

    async function analyzeDocument() {
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file first.");
      spinner.style.display = 'block';
      debugConsole.textContent = "";

      try {
        const url = `${endpoint}formrecognizer/documentModels/${modelId}:analyze?api-version=2023-07-31`;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/pdf',
            'Ocp-Apim-Subscription-Key': apiKey
          },
          body: file
        });

        const operationLocation = response.headers.get('operation-location');
        if (!operationLocation) throw new Error("Missing operation-location header");

        let result;
        for (let i = 0; i < 10; i++) {
          await new Promise(res => setTimeout(res, 2000));
          const pollRes = await fetch(operationLocation, {
            headers: { 'Ocp-Apim-Subscription-Key': apiKey }
          });
          const pollJson = await pollRes.json();
          debugConsole.textContent += `Poll ${i + 1}: ${pollJson.status}\n`;
          if (pollJson.status === "succeeded") {
            result = pollJson.analyzeResult;
            break;
          }
        }

        if (!result) throw new Error("Timed out waiting for analysis result");
        jsonOutput.textContent = JSON.stringify(result, null, 2);

        const fields = result.documents[0].fields || {};
        form.ownerName.value = fields.ownerName?.content || "";
        form.ownerAddress.value = fields.ownerAddress?.content || "";
        form.date.value = fields.date?.content || "";
        form.vesselName.value = fields.vesselName?.content || "";
        form.portLoading.value = fields.portLoading?.content || "";
        form.portDischarge.value = fields.portDischarge?.content || "";
        form.cargoDescription.value = fields.cargoDescription?.content || "";
        form.billDetails.value = fields.billDetails?.content || "";
        form.shipperName.value = fields.shipperName?.content || "";
        form.consigneeName.value = fields.consigneeName?.content || "";
        form.requestorName.value = fields.requestorName?.content || "";
        form.deliveryName.value = fields.deliveryName?.content || "";
        form.deliveryPlace.value = fields.deliveryPlace?.content || "";
        form.signatoryFullName.value = fields.signatoryFullName?.content || "";
        updatePreview();
      } catch (err) {
        debugConsole.textContent += `\n❌ Error: ${err.message}`;
        alert("Document analysis failed. See debug console for details.");
      } finally {
        spinner.style.display = 'none';
      }
    }
  </script>
</body>
</html>
